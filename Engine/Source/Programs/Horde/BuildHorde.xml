<?xml version='1.0' ?>
<BuildGraph xmlns="http://www.epicgames.com/BuildGraph" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.epicgames.com/BuildGraph ../../../Engine/Build/Graph/Schema.xsd" >

	<Option Name="PreflightChange" DefaultValue="" Description="Preflight changelist number"/>
	<Option Name="Configuration" DefaultValue="release" Description="Configuration to build"/>
	
	<Property Name="EngineDir" Value="$(RootDir)/Engine"/>

	<Property Name="Version" Value="$(EngineMajorVersion).$(EngineMinorVersion).$(EnginePatchVersion)"/>
	<Property Name="InformationalVersion" Value="$(Version)-$(Change)"/>
	<Property Name="InformationalVersion" Value="$(InformationalVersion)-PF-$(PreflightChange)" If="'$(PreflightChange)' != ''"/>
	<Property Name="VersionArguments" Value="/p:Version=$(Version).0 /p:InformationalVersion=$(InformationalVersion)"/>

	<!-- SERVER -->

	<Agent Name="HordeServer" Type="Linux;Win64_Docker">
		<Property Name="StagingDir" Value="$(RootDir)/Engine/Saved/Horde.Server"/>
		
		<Node Name="Build HordeServer">
			<!-- Tag all the files that need to be staged to build -->
			<Property Name="StagePaths">
				Engine/Binaries/DotNET/EpicGames.Perforce.Native/...
				Engine/Source/Programs/Shared/...
				Engine/Source/Programs/Horde/...
				Engine/Source/Programs/AutomationTool/AutomationUtils/Matchers/...
				Engine/Source/Programs/UnrealBuildTool/Matchers/...
			</Property>
			<Tag Files="$(StagePaths)" Except=".../.vs/...;.../.git/...;.../bin/...;.../obj/..." With="#InputFiles"/>

			<!-- Build the Docker image and publish it -->
			<Docker-Build BaseDir="Engine" Files="#InputFiles" Tag="hordeserver-public" DockerFile="Engine/Source/Programs/Horde/Horde.Server/Dockerfile" Arguments="--build-arg msbuild_args=&quot;$(VersionArguments)&quot;"/>
		</Node>
	</Agent>
	
	<!-- INSTALLER -->
	
	<Property Name="InstallerDir" Value="$(RootDir)/Engine/Source/Programs/Horde/Installer"/>
	<Property Name="InstallerConfig" Value="Debug"/>
	<Property Name="InstallerOutputDir" Value="$(RootDir)/Engine/Source/Programs/Horde/Installer/bin/$(InstallerConfig)"/>
	
	<Agent Name="HordeInstallerDashboard" Type="Linux">
		<Property Name="StagingDir" Value="$(RootDir)/Staging"/>
		<Property Name="DashboardVersion" Value="Unversioned"/>
		<Property Name="DashboardVersion" Value="CL-$(Change)" If="'$(Change)' != ''"/>
		<Property Name="DashboardVersion" Value="$(DashboardVersion)-PF-$(PreflightChange)" If="'$(PreflightChange)' != ''" />

		<Node Name="Stage Horde Installer Dashboard" Produces="#DashboardOutputFiles">
			<Delete Files="$(StagingDir)/Dashboard/..."/>		
			<WriteTextFile File="$(StagingDir)/Dashboard/index.html" Text="placeholder"/>			
		
			<!-- Build the dashboard -->
			<Tag Files="Engine/Source/Programs/Horde/HordeDashboard/..." With="#DashboardInputFiles"/>
			<Docker-Build BaseDir="Engine/Source" Files="#DashboardInputFiles" Tag="hordedashboard:installer" DockerFile="Engine/Source/Programs/Horde/HordeDashboard/installer/Dockerfile" Arguments="--build-arg &quot;VersionInfo=$(DashboardVersion)&quot;"/>
			
			<!-- Create a container from the image that can copy files from, note that this does not start the container -->
			<Docker Arguments="create --name horde-installer-container hordedashboard:installer"/>
			
			<!-- Copy the dashboard build to the server -->
			<Docker Arguments="cp horde-installer-container:app/Dashboard/build/. &quot;$(StagingDir)/Dashboard&quot;"/>

			<!-- Remove the container now that files are copied -->
			<Docker Arguments="rm horde-installer-container"/>
	
			<!-- Copy the Horde documentation to the dashboard public folder -->
			<Copy From="$(RootDir)/Engine/Restricted/NotForLicensees/Source/Programs/Horde/Docs/..." To="$(StagingDir)/Dashboard/public/documentation/..."/>		
			
			<Tag Files="$(StagingDir)/Dashboard/..." With="#DashboardOutputFiles"/>
		</Node>
	</Agent>
	
	<Agent Name="HordeInstaller" Type="Win64;CompileWin64">
		<Property Name="StagingDir" Value="$(RootDir)/Staging"/>

		<Node Name="Stage Horde Installer" Requires="#DashboardOutputFiles">
			<Delete Files="$(StagingDir)/Server/..."/>
			<Delete Files="$(StagingDir)/Agent/..."/>
			<DotNet Arguments="publish &quot;$(RootDir)/Engine/Source/Programs/Horde/Horde.Server/Horde.Server.csproj&quot; --output &quot;$(StagingDir)/Server&quot; --runtime win-x64 $(VersionArguments)"/>
			<DotNet Arguments="publish &quot;$(RootDir)/Engine/Source/Programs/Horde/Horde.Agent/Horde.Agent.csproj&quot; --output &quot;$(StagingDir)/Agent&quot; $(VersionArguments)"/>

			<!-- Do not include development defaults which created a ue5 project and stream -->
			<Delete Files="$(StagingDir)/Server/Defaults/..."/>

			<!-- Create build settings -->
			<WriteTextFile File="$(StagingDir)/Server/appsettings.Build.json" Text="{ &quot;Horde&quot;: { &quot;SingleInstance&quot;: true } }"/>
			
			<!-- Copy the Dashboard -->
			<Copy Files="#DashboardOutputFiles" From="$(StagingDir)/Dashboard/..." To="$(StagingDir)/Server/DashboardApp/..." />
		</Node>

		<Property Name="WixDir" Value="$(RootDir)/Engine/Source/ThirdParty/WiX/3.8"/>
		<Property Name="ObjDir" Value="obj/$(InstallerConfig)"/>
		<Property Name="BinDir" Value="bin/$(InstallerConfig)"/>
		
		<Node Name="Build Horde Installer" Requires="Stage Horde Installer">
			<Property Name="CommonArgs" Value="-dConfiguration=$(InstallerConfig) -dPlatform=x64 -arch x64"/>

			<Delete Files="$(StagingDir)/Server-Bulk/..."/>
			<Tag Files="$(StagingDir)/Server/..." Except="Horde.Server.exe" With="#ServerFiles"/>
			<Copy Files="#ServerFiles" From="$(StagingDir)/Server" To="$(StagingDir)/Server-Bulk/Server"/>
			<Spawn Exe="$(WixDir)/heat.exe" Arguments="dir &quot;$(StagingDir)/Server-Bulk&quot; -cg HordeServerFiles -scom -sreg -gg -dr InstallDir -srd -var var.SourceDir -out &quot;$(InstallerDir)/HordeServerFiles.wxs&quot;"/>
			<Spawn Exe="$(WixDir)/candle.exe" Arguments="$(CommonArgs) HordeServerFiles.wxs -dSourceDir=&quot;$(StagingDir)&quot; -out $(ObjDir)/HordeServerFiles.wixobj" WorkingDir="$(InstallerDir)"/>

			<Spawn Exe="$(WixDir)/candle.exe" Arguments="$(CommonArgs) Installer.wxs -dStagingDir=&quot;$(StagingDir)&quot; -out $(ObjDir)/Installer.wixobj" WorkingDir="$(InstallerDir)"/>
			<Spawn Exe="$(WixDir)/light.exe" Arguments="-out $(BinDir)/Horde.msi -sw1076 -pdbout $(BinDir)/Horde.pdb $(ObjDir)/Installer.wixobj $(ObjDir)/HordeServerFiles.wixobj" WorkingDir="$(InstallerDir)"/>
		</Node>
		
	</Agent>

</BuildGraph>
